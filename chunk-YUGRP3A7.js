import{A as v,B as w,Hb as T,M as b,Q as u,Tb as P,V as D,Vb as l,a as _,b as A,ga as s,n as h,r as S,x as M}from"./chunk-C5UHGNWP.js";var d=class{static dataForSliderPrincipal(a){let e=a.slice(0,5).map(t=>({codi:t.codi,image:t.imatges.split(",").at(0)??"",denominaci:t.denominaci??"",data_inici:t.data_inici??new Date}));return[...e,...e,...e]}static dataForEventList(a){return a.map(e=>({codi:e.codi,image:e.imatges.split(",").at(0)??"",denominaci:e.denominaci??"",categorias:e.categorias,comarca_i_municipi:e.comarca_i_municipi,modalitat:e.modalitat}))}static dataForMapPage(a){return a.filter(t=>t.latitud&&t.longitud||t.georefer_ncia).map(t=>{let o={codi:t.codi,denominaci:t.denominaci??"Sense descripci\xF3",lat:t.latitud??t.georefer_ncia?.coordinates[0].toLocaleString()??"",lon:t.longitud??t.georefer_ncia?.coordinates[1].toLocaleString()??"",categoria:t.categorias,url:""};return o.url=`https://www.google.com/maps?q=${o.lat},${o.lon}`,o})}};var L=window.localStorage,f=class i{Storage=s(L);constructor(){}saveData(a,e){this.Storage().setItem(a,e)}getData(a){return this.Storage().getItem(a)}isOldData(){let a=Number(this.Storage().getItem(l.UPDATED_EVENTS_DATE));return Date.now()>a}clearAllData(){this.Storage().clear}static \u0275fac=function(e){return new(e||i)};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};var N=class i{http=D(P);storage=D(f);eventosPermanentes=s([]);eventosTemporales=s([]);categorias=s([]);comarcas=s([]);provincias=s([]);municipis=s([]);logo=s("images/enjoy.png");cargando=s(!1);BASE_URL=l.URL;eventosProximos=T(()=>d.dataForSliderPrincipal(this.eventosTemporales()));eventosMap=T(()=>d.dataForMapPage([...this.eventosTemporales(),...this.eventosPermanentes()]));constructor(){this.getAllEvents()}getAllEvents(){this.cargando.set(!0);let a=this.storage.getData(l.EVENTS_DATA);if(a){let e=JSON.parse(a);e&&(this.getDataEventsMappedToSignals(e),this.getDataEventsTemporalesMappedToSignal(e),console.log("Recuperando data"),this.cargando.set(!1))}this.storage.isOldData()&&(console.log("data nueva--->descargando"),this.loadTemporalesFiltered().pipe(b(e=>{this.getDataEventsTemporalesMappedToSignal(e),console.log("Eventos temporales cargados:",e.length),this.cargando.set(!1)}),w(()=>this.loadPermanentesFiltered()),b(e=>{this.getDataEventsMappedToSignals(e),console.log("Eventos permanentes cargados:",e.length);let t=[...this.eventosTemporales(),...this.eventosPermanentes()],o=Date.now()+480*60*1e3;this.storage.saveData(l.EVENTS_DATA,JSON.stringify(t)),this.storage.saveData(l.UPDATED_EVENTS_DATE,o+""),console.log("Cambios en data")}),v(e=>(console.error("Error cargando eventos:",e),this.cargando.set(!1),h([])))).subscribe())}loadTemporalesFiltered(){let t=[];for(let o=0;o<8;o++){let r=o*1e4,g=`${this.BASE_URL}?$limit=10000&$offset=${r}`;t.push(this.http.get(g))}return M(t).pipe(S(o=>{let r=o.flat();return console.log("Total eventos descargados:",r.length),r}),v(o=>(console.error("Error cargando eventos temporales:",o),h([]))))}loadPermanentesFiltered(){let e=`${this.BASE_URL}?$where=${encodeURIComponent("amagar_dates = 'true'")}&$limit=50000`;return this.http.get(e).pipe(v(t=>(console.error("Error cargando eventos permanentes:",t),this.loadPermanentesFilteredAlternative())))}loadPermanentesFilteredAlternative(){console.log("Usando m\xE9todo alternativo para permanentes");let a=`${this.BASE_URL}?$limit=60000`;return this.http.get(a).pipe(S(e=>e.filter(t=>t.amagar_dates==="true")))}getDataEventsMappedToSignals(a){let e=new Set,t=new Set,o=new Set,r=new Set,g=new Set,y=Array.from(a).filter(n=>n.amagar_dates==="true"?g.has(+n.codi)?!1:(g.add(+n.codi),!0):!1),F=Array.from(y).map(n=>{let m=n.tags_categor_es?.replaceAll("agenda:categories/","")??"",$=n.tags_mbits?.replaceAll("agenda:ambits/","")??"",p=n.comarca?.replaceAll("agenda:ubicacions/","")??"",E=n.comarca_i_municipi?.replaceAll(`agenda:ubicacions/${p}/`,"")??"";if(m.split(",").forEach(c=>{c&&e.add(c)}),p){let c=p.split("/");c[0]&&o.add(c[0]),c[1]&&t.add(c[1])}return E&&r.add(E.replaceAll("agenda:ubicacions/","")),A(_({},n),{tags_categor_es:m,categorias:m.split(","),tags_mbits:$,comarca:p,comarca_i_municipi:E.replaceAll("agenda:ubicacions/","")})});this.categorias.set(Array.from(e)),this.provincias.set(Array.from(o)),this.comarcas.set(Array.from(t)),this.eventosPermanentes.set(F),this.municipis.set(Array.from(r).sort((n,m)=>n.localeCompare(m)))}getDataEventsTemporalesMappedToSignal(a){console.log("Eventos recibidos en getDataEventsTemporalesMappedToSignal:",a.length);let e=new Set,t=Array.from(a).filter(r=>!r.amagar_dates&&r.data_inici&&new Date(r.data_inici)>new Date?e.has(+r.codi)?!1:(e.add(+r.codi),!0):!1);console.log("Eventos temporales despu\xE9s de filtrar y eliminar duplicados:",t.length);let o=t.sort((r,g)=>new Date(r.data_inici).getTime()-new Date(g.data_inici).getTime());this.eventosTemporales.set(o),console.log("Eventos temporales finales:",o.length)}getEventsByCategory(a){let e=[...this.eventosPermanentes(),...this.eventosTemporales()];return console.log(e.length),a?e.filter(o=>!!(o.categorias&&o.categorias.includes(a))):e}getEventByCodi(a){let e=this.eventosTemporales().filter(t=>+t.codi==+a);return e.length!=0?e[0]:this.eventosPermanentes().filter(t=>+t.codi==+a)[0]??[]}static \u0275fac=function(e){return new(e||i)};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};export{d as a,f as b,N as c};
