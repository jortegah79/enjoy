import{Gb as b,M as v,Q as u,Rb as w,Tb as m,U as M,V as D,a as S,b as _,ga as o,r as T,x as A}from"./chunk-YJAG7FBE.js";var p=class{static dataForSliderPrincipal(t){let e=t.slice(0,5).map(a=>({codi:a.codi,image:a.imatges.split(",").at(0)??"",denominaci:a.denominaci??"",data_inici:a.data_inici??new Date}));return[...e,...e,...e]}static dataForEventList(t){return t.map(e=>({codi:e.codi,image:e.imatges.split(",").at(0)??"",denominaci:e.denominaci??"",categorias:e.categorias,comarca_i_municipi:e.comarca_i_municipi,modalitat:e.modalitat}))}static dataForMapPage(t){return t.filter(a=>a.latitud&&a.longitud||a.georefer_ncia).map(a=>{let i={codi:a.codi,denominaci:a.denominaci??"Sense descripci\xF3",lat:a.latitud??a.georefer_ncia?.coordinates[0].toLocaleString()??"",lon:a.longitud??a.georefer_ncia?.coordinates[1].toLocaleString()??"",categoria:a.categorias,url:""};return i.url=`https://www.google.com/maps?q=${i.lat},${i.lon}`,i})}};var f=class s{constructor(t){this.storage=t}saveData(t,e){this.storage.setItem(t,e)}getData(t){return this.storage.getItem(t)}isOldData(){let t=Number(this.storage.getItem(m.UPDATED_EVENTS_DATE));return Date.now()>t}clearAllData(){this.storage.clear()}static \u0275fac=function(e){return new(e||s)(M("APP_STORAGE"))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var P=class s{http=D(w);storage=D(f);eventosPermanentes=o([]);eventosTemporales=o([]);categorias=o([]);comarcas=o([]);provincias=o([]);municipis=o([]);logo=o("images/enjoy.png");cargando=o(!1);BASE_URL=m.URL;eventosProximos=b(()=>p.dataForSliderPrincipal(this.eventosTemporales()));eventosMap=b(()=>p.dataForMapPage([...this.eventosTemporales(),...this.eventosPermanentes()]));constructor(){this.getAllEvents()}getAllEvents(){if(this.cargando.set(!0),!this.storage.isOldData()){let t=this.storage.getData(m.EVENTS_DATA);if(t){let e=JSON.parse(t);if(e){this.getDataEventsMappedToSignals(e),this.getDataEventsTemporalesMappedToSignal(e),this.cargando.set(!1);return}}}this.loadAllChunks().pipe(v(t=>this.getDataEventsMappedToSignals(t)),v(t=>this.getDataEventsTemporalesMappedToSignal(t)),v(t=>{let e=[...this.eventosTemporales(),...this.eventosPermanentes()],a=Date.now()+8*60*60*1e3;this.storage.saveData(m.EVENTS_DATA,JSON.stringify(e)),this.storage.saveData(m.UPDATED_EVENTS_DATE,a+""),this.cargando.set(!1)})).subscribe()}loadAllChunks(t=7e4,e=1e4){let a=Math.ceil(t/e),i=[];for(let r=0;r<a;r++){let l=r*e,E=`${this.BASE_URL}?$limit=${e}&$offset=${l}`;i.push(this.http.get(E))}return A(i).pipe(T(r=>r.flat()))}getDataEventsMappedToSignals(t){let e=new Set,a=new Set,i=new Set,r=new Set,l=new Set,E=Array.from(t).filter(n=>n.amagar_dates==="true"?l.has(+n.codi)?!1:(l.add(+n.codi),!0):!1),N=Array.from(E).map(n=>{let g=n.tags_categor_es?.replaceAll("agenda:categories/","")??"",y=n.tags_mbits?.replaceAll("agenda:ambits/","")??"",d=n.comarca?.replaceAll("agenda:ubicacions/","")??"",h=n.comarca_i_municipi?.replaceAll(`agenda:ubicacions/${d}/`,"")??"";if(g.split(",").forEach(c=>{c&&e.add(c)}),d){let c=d.split("/");c[0]&&i.add(c[0]),c[1]&&a.add(c[1])}return h&&r.add(h.replaceAll("agenda:ubicacions/","")),_(S({},n),{tags_categor_es:g,categorias:g.split(","),tags_mbits:y,comarca:d,comarca_i_municipi:h.replaceAll("agenda:ubicacions/","")})});this.categorias.set(Array.from(e)),this.provincias.set(Array.from(i)),this.comarcas.set(Array.from(a)),this.eventosPermanentes.set(N),this.municipis.set(Array.from(r).sort((n,g)=>n.localeCompare(g)))}getDataEventsTemporalesMappedToSignal(t){let e=new Set,i=Array.from(t).filter(r=>!r.amagar_dates&&r.data_inici&&new Date(r.data_inici)>new Date?e.has(+r.codi)?!1:(e.add(+r.codi),!0):!1).sort((r,l)=>new Date(r.data_inici).getTime()-new Date(l.data_inici).getTime());this.eventosTemporales.set(i)}getEventsByCategory(t){let e=[...this.eventosPermanentes(),...this.eventosTemporales()];return t?e.filter(i=>!!(i.categorias&&i.categorias.includes(t))):e}getEventByCodi(t){let e=this.eventosTemporales().filter(a=>+a.codi==+t);return e.length!=0?e[0]:this.eventosPermanentes().filter(a=>+a.codi==+t)[0]??[]}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{p as a,f as b,P as c};
