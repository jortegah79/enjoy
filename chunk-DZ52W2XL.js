import{Gb as D,M as v,Q as u,Sb as A,Ub as l,V as S,a as b,b as _,ga as n,r as T,x as M}from"./chunk-JYIPF76R.js";var d=class{static dataForSliderPrincipal(t){let e=t.slice(0,5).map(a=>({codi:a.codi,image:a.imatges.split(",").at(0)??"",denominaci:a.denominaci??"",data_inici:a.data_inici??new Date}));return[...e,...e,...e]}static dataForEventList(t){return t.map(e=>({codi:e.codi,image:e.imatges.split(",").at(0)??"",denominaci:e.denominaci??"",categorias:e.categorias,comarca_i_municipi:e.comarca_i_municipi,modalitat:e.modalitat}))}static dataForMapPage(t){return t.filter(a=>a.latitud&&a.longitud||a.georefer_ncia).map(a=>{let r={codi:a.codi,denominaci:a.denominaci??"Sense descripci\xF3",lat:a.latitud??a.georefer_ncia?.coordinates[0].toLocaleString()??"",lon:a.longitud??a.georefer_ncia?.coordinates[1].toLocaleString()??"",categoria:a.categorias,url:""};return r.url=`https://www.google.com/maps?q=${r.lat},${r.lon}`,r})}};var F=window.localStorage,f=class s{Storage=n(F);constructor(){}saveData(t,e){this.Storage().setItem(t,e)}getData(t){return this.Storage().getItem(t)}isOldData(){let t=Number(this.Storage().getItem(l.UPDATED_EVENTS_DATE));return Date.now()>t}clearAllData(){this.Storage().clear}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var w=class s{http=S(A);storage=S(f);eventosPermanentes=n([]);eventosTemporales=n([]);categorias=n([]);comarcas=n([]);provincias=n([]);municipis=n([]);logo=n("images/enjoy.png");cargando=n(!1);BASE_URL=l.URL;eventosProximos=D(()=>d.dataForSliderPrincipal(this.eventosTemporales()));eventosMap=D(()=>d.dataForMapPage([...this.eventosTemporales(),...this.eventosPermanentes()]));constructor(){this.getAllEvents()}getAllEvents(){if(this.cargando.set(!0),!this.storage.isOldData()){let t=this.storage.getData(l.EVENTS_DATA);if(t){let e=JSON.parse(t);if(e){this.getDataEventsMappedToSignals(e),this.getDataEventsTemporalesMappedToSignal(e),console.log("Recuperando data"),this.cargando.set(!1);return}}}console.log("data nueva--->descargando"),this.loadAllChunks().pipe(v(t=>this.getDataEventsMappedToSignals(t)),v(t=>this.getDataEventsTemporalesMappedToSignal(t)),v(t=>{let e=[...this.eventosTemporales(),...this.eventosPermanentes()],a=Date.now()+8*60*60*1e3;this.storage.saveData(l.EVENTS_DATA,JSON.stringify(e)),this.storage.saveData(l.UPDATED_EVENTS_DATE,a+""),this.cargando.set(!1)})).subscribe()}loadAllChunks(t=7e4,e=1e4){let a=Math.ceil(t/e),r=[];for(let i=0;i<a;i++){let m=i*e,E=`${this.BASE_URL}?$limit=${e}&$offset=${m}`;r.push(this.http.get(E))}return M(r).pipe(T(i=>i.flat()))}getDataEventsMappedToSignals(t){let e=new Set,a=new Set,r=new Set,i=new Set,m=new Set,E=Array.from(t).filter(o=>o.amagar_dates==="true"?m.has(+o.codi)?!1:(m.add(+o.codi),!0):!1),N=Array.from(E).map(o=>{let g=o.tags_categor_es?.replaceAll("agenda:categories/","")??"",y=o.tags_mbits?.replaceAll("agenda:ambits/","")??"",p=o.comarca?.replaceAll("agenda:ubicacions/","")??"",h=o.comarca_i_municipi?.replaceAll(`agenda:ubicacions/${p}/`,"")??"";if(g.split(",").forEach(c=>{c&&e.add(c)}),p){let c=p.split("/");c[0]&&r.add(c[0]),c[1]&&a.add(c[1])}return h&&i.add(h.replaceAll("agenda:ubicacions/","")),_(b({},o),{tags_categor_es:g,categorias:g.split(","),tags_mbits:y,comarca:p,comarca_i_municipi:h.replaceAll("agenda:ubicacions/","")})});this.categorias.set(Array.from(e)),this.provincias.set(Array.from(r)),this.comarcas.set(Array.from(a)),this.eventosPermanentes.set(N),this.municipis.set(Array.from(i).sort((o,g)=>o.localeCompare(g)))}getDataEventsTemporalesMappedToSignal(t){let e=new Set,r=Array.from(t).filter(i=>!i.amagar_dates&&i.data_inici&&new Date(i.data_inici)>new Date?e.has(+i.codi)?!1:(e.add(+i.codi),!0):!1).sort((i,m)=>new Date(i.data_inici).getTime()-new Date(m.data_inici).getTime());this.eventosTemporales.set(r)}getEventsByCategory(t){let e=[...this.eventosPermanentes(),...this.eventosTemporales()];return console.log(e.length),t?e.filter(r=>!!(r.categorias&&r.categorias.includes(t))):e}getEventByCodi(t){let e=this.eventosTemporales().filter(a=>+a.codi==+t);return e.length!=0?e[0]:this.eventosPermanentes().filter(a=>+a.codi==+t)[0]??[]}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{d as a,f as b,w as c};
