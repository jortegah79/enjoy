import{Db as S,L as v,O as u,Ob as A,Qb as m,T as h,a as b,b as _,ea as n,r as T,x as M}from"./chunk-2FEQYACG.js";var p=class{static dataForSliderPrincipal(t){let e=t.slice(0,5).map(a=>({codi:a.codi,image:a.imatges.split(",").at(0)??"",denominaci:a.denominaci??"",data_inici:a.data_inici??new Date}));return[...e,...e,...e]}static dataForEventList(t){return t.map(e=>({codi:e.codi,image:e.imatges.split(",").at(0)??"",denominaci:e.denominaci??"",categorias:e.categorias,comarca_i_municipi:e.comarca_i_municipi,modalitat:e.modalitat}))}static dataForMapPage(t){return t.filter(a=>a.latitud&&a.longitud||a.georefer_ncia).map(a=>{let o={codi:a.codi,denominaci:a.denominaci??"Sense descripci\xF3",lat:a.latitud??a.georefer_ncia?.coordinates[0].toLocaleString()??"",lon:a.longitud??a.georefer_ncia?.coordinates[1].toLocaleString()??"",categoria:a.categorias,url:""};return o.url=`https://www.google.com/maps?q=${o.lat},${o.lon}`,o})}};var O=window.localStorage,f=class s{Storage=n(O);constructor(){}saveData(t,e){this.Storage().setItem(t,e)}getData(t){return this.Storage().getItem(t)}isOldData(){let t=Number(this.Storage().getItem(m.UPDATED_EVENTS_DATE));return Date.now()>t}clearAllData(){this.Storage().clear}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var w=class s{http=h(A);storage=h(f);eventosPermanentes=n([]);eventosTemporales=n([]);categorias=n([]);comarcas=n([]);provincias=n([]);municipis=n([]);logo=n("images/enjoy.png");cargando=n(!1);BASE_URL=m.URL;eventosProximos=S(()=>p.dataForSliderPrincipal(this.eventosTemporales()));eventosMap=S(()=>p.dataForMapPage([...this.eventosTemporales(),...this.eventosPermanentes()]));constructor(){this.getAllEvents()}getAllEvents(){if(this.cargando.set(!0),!this.storage.isOldData()){let t=this.storage.getData(m.EVENTS_DATA);if(t){let e=JSON.parse(t);if(e){this.getDataEventsMappedToSignals(e),this.getDataEventsTemporalesMappedToSignal(e),console.log("Recuperando data"),this.cargando.set(!1);return}}}console.log("data nueva--->descargando"),this.loadAllChunks().pipe(v(t=>this.getDataEventsMappedToSignals(t)),v(t=>this.getDataEventsTemporalesMappedToSignal(t)),v(t=>{let e=[...this.eventosTemporales(),...this.eventosPermanentes()],a=Date.now()+8*60*60*1e3;this.storage.saveData(m.EVENTS_DATA,JSON.stringify(e)),this.storage.saveData(m.UPDATED_EVENTS_DATE,a+""),this.cargando.set(!1)})).subscribe()}loadAllChunks(t=7e4,e=1e4){let a=Math.ceil(t/e),o=[];for(let i=0;i<a;i++){let l=i*e,D=`${this.BASE_URL}?$limit=${e}&$offset=${l}`;o.push(this.http.get(D))}return M(o).pipe(T(i=>i.flat()))}getDataEventsMappedToSignals(t){let e=new Set,a=new Set,o=new Set,i=new Set,l=new Set;Array.from(Object.values(t)).filter(r=>r.amagar_dates==="true").forEach(r=>l.add(r));let N=Array.from(l).map(r=>{let g=r.tags_categor_es?.replaceAll("agenda:categories/","")??"",y=r.tags_mbits?.replaceAll("agenda:ambits/","")??"",d=r.comarca?.replaceAll("agenda:ubicacions/","")??"",E=r.comarca_i_municipi?.replaceAll(`agenda:ubicacions/${d}/`,"")??"";if(g.split(",").forEach(c=>{c&&e.add(c)}),d){let c=d.split("/");c[0]&&o.add(c[0]),c[1]&&a.add(c[1])}return E&&i.add(E.replaceAll("agenda:ubicacions/","")),_(b({},r),{tags_categor_es:g,categorias:g.split(","),tags_mbits:y,comarca:d,comarca_i_municipi:E.replaceAll("agenda:ubicacions/","")})});this.categorias.set(Array.from(e)),this.provincias.set(Array.from(o)),this.comarcas.set(Array.from(a)),this.eventosPermanentes.set(N),this.municipis.set(Array.from(i).sort((r,g)=>r.localeCompare(g)))}getDataEventsTemporalesMappedToSignal(t){let e=new Set;t.forEach(i=>e.add(i));let o=Array.from(e).filter(i=>!i.amagar_dates&&i.data_inici&&new Date(i.data_inici)>new Date).sort((i,l)=>new Date(i.data_inici).getTime()-new Date(l.data_inici).getTime());this.eventosTemporales.set(o)}getEventsByCategory(t){let e=[...this.eventosPermanentes(),...this.eventosTemporales()];return console.log(e.length),t?e.filter(o=>!!(o.categorias&&o.categorias.includes(t))):e}getEventByCodi(t){let e=this.eventosTemporales().filter(a=>+a.codi==+t);return e.length!=0?e[0]:this.eventosPermanentes().filter(a=>+a.codi==+t)[0]??[]}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{p as a,f as b,w as c};
