import{Db as D,L as d,O as v,Ob as A,Qb as l,T as h,a as b,b as _,ea as o,r as T,x as M}from"./chunk-2FEQYACG.js";var g=class{static dataForSliderPrincipal(t){let e=t.slice(0,5).map(a=>({codi:a.codi,image:a.imatges.split(",").at(0)??"",denominaci:a.denominaci??"",data_inici:a.data_inici??new Date}));return[...e,...e,...e]}static dataForEventList(t){return t.map(e=>({codi:e.codi,image:e.imatges.split(",").at(0)??"",denominaci:e.denominaci??"",categorias:e.categorias,comarca_i_municipi:e.comarca_i_municipi,modalitat:e.modalitat}))}static dataForMapPage(t){return t.filter(a=>a.latitud&&a.longitud||a.georefer_ncia).map(a=>{let i={codi:a.codi,denominaci:a.denominaci??"Sense descripci\xF3",lat:a.latitud??a.georefer_ncia?.coordinates[0].toLocaleString()??"",lon:a.longitud??a.georefer_ncia?.coordinates[1].toLocaleString()??"",categoria:a.categorias,url:""};return i.url=`https://www.google.com/maps?q=${i.lat},${i.lon}`,i})}};var y=window.localStorage,u=class s{Storage=o(y);constructor(){}saveData(t,e){this.Storage().setItem(t,e)}getData(t){return this.Storage().getItem(t)}isOldData(){let t=Number(this.Storage().getItem(l.UPDATED_EVENTS_DATE));return Date.now()>t}clearAllData(){this.Storage().clear}static \u0275fac=function(e){return new(e||s)};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};var w=class s{http=h(A);storage=h(u);eventosPermanentes=o([]);eventosTemporales=o([]);categorias=o([]);comarcas=o([]);provincias=o([]);municipis=o([]);logo=o("images/enjoy.png");cargando=o(!1);BASE_URL=l.URL;eventosProximos=D(()=>g.dataForSliderPrincipal(this.eventosTemporales()));eventosMap=D(()=>g.dataForMapPage([...this.eventosTemporales(),...this.eventosPermanentes()]));constructor(){this.getAllEvents()}getAllEvents(){if(this.cargando.set(!0),!this.storage.isOldData()){let t=this.storage.getData(l.EVENTS_DATA);if(t){let e=JSON.parse(t);if(e){this.getDataEventsMappedToSignals(e),this.getDataEventsTemporalesMappedToSignal(e),console.log("Recuperando data"),this.cargando.set(!1);return}}}console.log("data nueva--->descargando"),this.loadAllChunks().pipe(d(t=>this.getDataEventsMappedToSignals(t)),d(t=>this.getDataEventsTemporalesMappedToSignal(t)),d(t=>{let e=[...this.eventosTemporales(),...this.eventosPermanentes()],a=Date.now()+8*60*60*1e3;this.storage.saveData(l.EVENTS_DATA,JSON.stringify(e)),this.storage.saveData(l.UPDATED_EVENTS_DATE,a+""),this.cargando.set(!1)})).subscribe()}loadAllChunks(t=7e4,e=1e4){let a=Math.ceil(t/e),i=[];for(let r=0;r<a;r++){let S=r*e,f=`${this.BASE_URL}?$limit=${e}&$offset=${S}`;i.push(this.http.get(f))}return M(i).pipe(T(r=>r.flat()))}getDataEventsMappedToSignals(t){let e=new Set,a=new Set,i=new Set,r=new Set,f=Array.from(Object.values(t)).filter(n=>n.amagar_dates==="true").map(n=>{let m=n.tags_categor_es?.replaceAll("agenda:categories/","")??"",N=n.tags_mbits?.replaceAll("agenda:ambits/","")??"",p=n.comarca?.replaceAll("agenda:ubicacions/","")??"",E=n.comarca_i_municipi?.replaceAll(`agenda:ubicacions/${p}/`,"")??"";if(m.split(",").forEach(c=>{c&&e.add(c)}),p){let c=p.split("/");c[0]&&i.add(c[0]),c[1]&&a.add(c[1])}return E&&r.add(E.replaceAll("agenda:ubicacions/","")),_(b({},n),{tags_categor_es:m,categorias:m.split(","),tags_mbits:N,comarca:p,comarca_i_municipi:E.replaceAll("agenda:ubicacions/","")})});this.categorias.set(Array.from(e)),this.provincias.set(Array.from(i)),this.comarcas.set(Array.from(a)),this.eventosPermanentes.set(f),this.municipis.set(Array.from(r).sort((n,m)=>n.localeCompare(m)))}getDataEventsTemporalesMappedToSignal(t){let a=Array.from(Object.values(t)).filter(i=>!i.amagar_dates&&i.data_inici&&new Date(i.data_inici)>new Date).sort((i,r)=>new Date(i.data_inici).getTime()-new Date(r.data_inici).getTime());this.eventosTemporales.set(a)}getEventsByCategory(t){let e=[...this.eventosPermanentes(),...this.eventosTemporales()];return console.log(e.length),t?e.filter(i=>!!(i.categorias&&i.categorias.includes(t))):e}getEventByCodi(t){let e=this.eventosTemporales().filter(a=>+a.codi==+t);return e.length!=0?e[0]:this.eventosPermanentes().filter(a=>+a.codi==+t)[0]??[]}static \u0275fac=function(e){return new(e||s)};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};export{g as a,u as b,w as c};
